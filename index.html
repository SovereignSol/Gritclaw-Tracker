<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Monk KI Tracker</title>

    <style>
      :root {
        --bg: #0b0f14;
        --card: rgba(18, 26, 35, 0.88);
        --text: #e9eef5;
        --muted: #97a6b8;
        --border: #223041;
        --btn: rgba(26, 39, 53, 0.9);
        --btnHover: rgba(34, 52, 71, 0.95);
        --danger: #ff6b6b;
        --ok: #7ce6a5;
      }

      * { box-sizing: border-box; }

      body {
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        background: var(--bg);
        color: var(--text);
        min-height: 100vh;
      }

      .wrap {
        max-width: 1100px;
        margin: 0 auto;
        padding: 22px 16px 56px;
      }

      .header h1 {
        margin: 0 0 6px;
        font-size: 28px;
        letter-spacing: 0.2px;
      }

      .sub { margin: 0; color: var(--muted); }

      .card {
        margin-top: 14px;
        padding: 14px;
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 14px;
        backdrop-filter: blur(2px);
      }

      .row {
        display: grid;
        grid-template-columns: 1fr 150px;
        gap: 12px;
        align-items: center;
      }

      .label { color: var(--muted); font-size: 14px; }

      input[type="number"], input[type="text"] {
        width: 100%;
        padding: 10px 10px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: rgba(15, 22, 32, 0.95);
        color: var(--text);
        outline: none;
      }

      .grid2 {
        margin-top: 10px;
        display: grid;
        grid-template-columns: 1fr;
        gap: 10px;
      }
      @media (min-width: 860px) {
        .grid2 { grid-template-columns: 1fr 1fr; }
      }

      .topStats {
        margin-top: 12px;
        display: grid;
        grid-template-columns: 1fr;
        gap: 10px;
      }
      @media (min-width: 860px) {
        .topStats { grid-template-columns: 1fr 1fr 1fr; }
      }

      .statBox {
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 12px;
        background: rgba(0,0,0,0.18);
      }
      .statLabel { font-size: 12px; color: var(--muted); }
      .statValue { margin-top: 4px; font-size: 18px; font-weight: 650; }

      .kiHeader {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        gap: 12px;
        margin-top: 6px;
      }
      .kiTitle { font-size: 18px; font-weight: 650; }
      .kiNumbers { color: var(--muted); font-size: 14px; }

      .kiBar {
        margin-top: 12px;
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 10px;
        background: rgba(0,0,0,0.18);
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(44px, 1fr));
        gap: 8px;
      }

      .kiOrb {
        width: 44px;
        height: 44px;
        display: grid;
        place-items: center;
        border-radius: 12px;
        overflow: hidden;
        border: 1px solid rgba(255,255,255,0.06);
        background: rgba(0,0,0,0.25);
      }

      .kiOrb img {
        width: 44px;
        height: 44px;
        object-fit: cover;
        display: block;
      }

      .controls {
        margin-top: 12px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
      }

      .btn {
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: var(--btn);
        color: var(--text);
        cursor: pointer;
        user-select: none;
      }
      .btn:hover { background: var(--btnHover); }
      .btn:disabled { opacity: 0.45; cursor: not-allowed; }

      .qBtn {
        width: 40px;
        height: 40px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: rgba(0,0,0,0.12);
        color: var(--text);
        cursor: pointer;
        font-weight: 800;
      }
      .qBtn:hover { background: rgba(255,255,255,0.06); }

      .statusBar {
        margin-top: 10px;
        min-height: 18px;
        font-size: 13px;
        color: var(--muted);
        white-space: pre-wrap;
      }
      .statusBar.ok { color: var(--ok); }
      .statusBar.error { color: var(--danger); }

      .sectionTitle {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        gap: 12px;
      }
      .sectionTitle h2 { margin: 0; font-size: 18px; }

      .abilityGrid {
        margin-top: 12px;
        display: grid;
        grid-template-columns: 1fr;
        gap: 10px;
      }
      @media (min-width: 900px) {
        .abilityGrid { grid-template-columns: 1fr 1fr; }
      }

      .abilityCard {
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 12px;
        background: rgba(0,0,0,0.18);
        display: grid;
        grid-template-columns: 56px 1fr auto;
        gap: 12px;
        align-items: center;
      }

      .abilityIcon {
        width: 56px;
        height: 56px;
        border-radius: 14px;
        overflow: hidden;
        background: rgba(0,0,0,0.25);
        border: 1px solid rgba(255,255,255,0.06);
        display: grid;
        place-items: center;
      }
      .abilityIcon img {
        width: 56px;
        height: 56px;
        object-fit: cover;
        display: block;
      }

      .missingIcon {
        font-size: 11px;
        color: var(--muted);
        padding: 6px;
        text-align: center;
        line-height: 1.2;
      }

      .abilityName { font-weight: 700; letter-spacing: 0.2px; }
      .abilityMeta { margin-top: 4px; font-size: 13px; color: var(--muted); }

      .abilityBtns { display: flex; gap: 8px; align-items: center; }

      select {
        padding: 10px 10px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: rgba(15, 22, 32, 0.95);
        color: var(--text);
        outline: none;
      }

      .refList {
        margin-top: 12px;
        display: grid;
        grid-template-columns: 1fr;
        gap: 10px;
      }
      @media (min-width: 900px) {
        .refList { grid-template-columns: 1fr 1fr; }
      }

      .refItem {
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 12px;
        background: rgba(0,0,0,0.18);
      }

      .refHead {
        display: flex;
        justify-content: space-between;
        gap: 12px;
        align-items: baseline;
      }
      .refName { font-weight: 700; }
      .refLevel { color: var(--muted); font-size: 13px; white-space: nowrap; }
      .refDesc {
        margin-top: 6px;
        color: var(--muted);
        font-size: 13px;
        line-height: 1.45;
        white-space: pre-wrap;
      }

      dialog {
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 0;
        background: rgba(15, 22, 32, 0.98);
        color: var(--text);
        max-width: 760px;
        width: calc(100% - 24px);
      }
      dialog::backdrop { background: rgba(0,0,0,0.65); }

      .dlgHead {
        padding: 14px 14px 10px;
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 12px;
      }
      .dlgTitle { margin: 0; font-size: 18px; }

      .dlgBody { padding: 14px; }
      .dlgBody p { margin: 0 0 10px; line-height: 1.5; white-space: pre-wrap; }
      .dlgMeta { margin-top: 8px; color: var(--muted); font-size: 13px; }

      .dlgActions {
        padding: 12px 14px 14px;
        border-top: 1px solid var(--border);
        display: flex;
        justify-content: flex-end;
        gap: 10px;
      }

      .tiny { font-size: 12px; color: var(--muted); }
      code.inline {
        padding: 2px 6px;
        border: 1px solid rgba(255,255,255,0.08);
        border-radius: 8px;
        background: rgba(0,0,0,0.25);
      }

      .footer {
        margin-top: 16px;
        font-size: 13px;
        color: var(--muted);
      }
    </style>
  </head>

  <body>
    <main class="wrap">
      <header class="header">
        <h1>Monk KI Tracker</h1>
        <p class="sub">Default paths fixed (icons/ and UI/), auto-detect runs once on first load.</p>
      </header>

      <section class="card" aria-label="Asset paths">
        <div class="sectionTitle">
          <h2>Asset Paths</h2>
          <div class="sub muted">Only change these if you rename folders.</div>
        </div>

        <div class="grid2">
          <div>
            <div class="label">Icons folder (yours is <code class="inline">icons/</code>)</div>
            <input id="iconsBaseInput" type="text" />
          </div>
          <div>
            <div class="label">UI folder (yours is <code class="inline">UI/</code>, case-sensitive)</div>
            <input id="uiBaseInput" type="text" />
          </div>
        </div>

        <div class="controls">
          <button id="applyPathsBtn" class="btn" type="button">Apply Paths</button>
          <button id="autoDetectBtn" class="btn" type="button">Auto-detect folders</button>
          <button id="resetPathsBtn" class="btn" type="button">Reset paths</button>
        </div>

        <div class="tiny">
          GitHub Pages is case-sensitive. Your UI folder is <code class="inline">UI</code> (uppercase), not <code class="inline">ui</code>.
        </div>

        <div id="assetStatus" class="statusBar"></div>
      </section>

      <section class="card" aria-label="Core">
        <div class="row">
          <label for="levelInput" class="label">Monk Level (1 to 20)</label>
          <input id="levelInput" type="number" min="1" max="20" step="1" />
        </div>

        <div class="topStats">
          <div class="statBox">
            <div class="statLabel">KI</div>
            <div class="statValue" id="kiText">0 / 0</div>
          </div>
          <div class="statBox">
            <div class="statLabel">Unarmored Movement Bonus</div>
            <div class="statValue" id="moveText">-</div>
          </div>
          <div class="statBox">
            <div class="statLabel">Martial Arts Die</div>
            <div class="statValue" id="madText">1d4</div>
          </div>
        </div>

        <div class="kiHeader">
          <div class="kiTitle">KI Orbs</div>
          <div class="kiNumbers">
            <span class="muted">Available:</span> <code class="inline">available_KI.webp</code>,
            <span class="muted">Spent:</span> <code class="inline">spent_KI.webp</code>
          </div>
        </div>

        <div id="kiBar" class="kiBar" aria-label="KI orbs bar"></div>

        <div class="controls">
          <button id="spend1" class="btn" type="button">Spend 1 KI</button>
          <button id="gain1" class="btn" type="button">Gain 1 KI</button>
          <button id="shortRest" class="btn" type="button">Short Rest (refill KI)</button>
          <button id="longRest" class="btn" type="button">Long Rest (refill KI)</button>
        </div>

        <div id="statusBar" class="statusBar" role="status" aria-live="polite"></div>
      </section>

      <section class="card" aria-label="KI Abilities">
        <div class="sectionTitle">
          <h2>KI Abilities (spend KI)</h2>
          <div class="sub muted">Only shows abilities you have by level.</div>
        </div>
        <div id="abilityGrid" class="abilityGrid"></div>
      </section>

      <section class="card" aria-label="Reference Features">
        <div class="sectionTitle">
          <h2>Reference (no KI cost)</h2>
          <div class="sub muted">No icons, no spending, just reminders.</div>
        </div>
        <div id="refList" class="refList"></div>
      </section>

      <footer class="footer">Saved in your browser (localStorage).</footer>

      <dialog id="infoDialog" aria-label="Ability definition dialog">
        <div class="dlgHead">
          <h3 class="dlgTitle" id="dlgTitle">Ability</h3>
          <button class="qBtn" id="dlgX" type="button" aria-label="Close dialog">Ã—</button>
        </div>
        <div class="dlgBody">
          <p id="dlgDesc"></p>
          <div class="dlgMeta" id="dlgMeta"></div>
        </div>
        <div class="dlgActions">
          <button class="btn" id="dlgClose" type="button">Close</button>
        </div>
      </dialog>
    </main>

    <script>
      "use strict";

      // Why it broke before:
      // Your assets are NOT in the repo root. They live in:
      // - icons/   (lowercase)
      // - UI/      (uppercase)
      // The previous default was "./", so it tried "./available_KI.webp" instead of "./UI/available_KI.webp".
      // Auto-detect found the right folders, which is why clicking it fixed everything.

      const STORAGE_KEY = "monk_ki_tracker_state_v1";
      const PATHS_KEY = "monk_ki_paths_v2";
      const FIRST_RUN_KEY = "monk_ki_first_run_v1";

      function clamp(n, min, max) { return Math.max(min, Math.min(max, n)); }
      function getMaxKI(level) {
        level = Number(level);
        if (!Number.isFinite(level)) return 0;
        if (level <= 1) return 0;
        return clamp(level, 2, 20);
      }

      const UNARMORED_MOVE = [
        "-", "+10 ft.", "+10 ft.", "+10 ft.", "+10 ft.",
        "+15 ft.", "+15 ft.", "+15 ft.", "+15 ft.",
        "+20 ft.", "+20 ft.", "+20 ft.", "+20 ft.",
        "+25 ft.", "+25 ft.", "+25 ft.", "+25 ft.",
        "+30 ft.", "+30 ft.", "+30 ft."
      ];
      const MARTIAL_DIE = [
        "1d4","1d4","1d4","1d4",
        "1d6","1d6","1d6","1d6","1d6","1d6",
        "1d8","1d8","1d8","1d8","1d8","1d8",
        "1d10","1d10","1d10","1d10"
      ];

      const FILES = {
        uiBackgroundCandidates: ["UI background.webp", "UI_background.webp", "UI background.webP", "UI_background.webP"],
        kiAvailable: "available_KI.webp",
        kiSpent: "spent_KI.webp",
      };

      // IMPORTANT: include your exact known folder names first
      const FOLDER_CANDIDATES = {
        icons: ["./icons/", "./Icons/", "./", "./assets/icons/", "./img/icons/", "./images/icons/"],
        ui: ["./UI/", "./ui/", "./", "./assets/ui/", "./img/ui/", "./images/ui/"],
      };

      const KI_ABILITIES = [
        { id: "extra_arms", name: "Extra Arms", icon: "Extra_arms.webp", level: 2, cost: 1,
          desc: "Immediately after you take the Attack action on your turn, you can spend 1 ki point to make 4 unarmed strikes as a bonus action." },
        { id: "patient_defense", name: "Patient Defense", icon: "Patient_Defense.webp", level: 2, cost: 1,
          desc: "You can spend 1 ki point to take the Dodge action as a bonus action on your turn." },
        { id: "step_of_the_wind", name: "Step of the Wind", icon: "Step_wind.webp", level: 2, cost: 1,
          desc: "You can spend 1 ki point to take the Disengage or Dash action as a bonus action on your turn, and your jump distance is doubled for the turn." },
        { id: "reflexive_tendril", name: "Reflexive Tendril", icon: "Reflexive_Tendril.webp", level: 3, cost: 1,
          desc:
`You can use your reaction to deflect or catch the missile when you are hit by a ranged weapon attack. When you do so, the damage you take from the attack is reduced by 1d10 + your Dexterity modifier + your monk level.

If you reduce the damage to 0, you can catch the missile if it is small enough for you to hold in one hand and you have at least one hand free. If you catch a missile in this way, you can spend 1 ki point to make a ranged attack with a range of 20/60 using the weapon or piece of ammunition you just caught, as part of the same reaction. You make this attack with proficiency, regardless of your weapon proficiencies, and the missile counts as a monk weapon for the attack.` },
        { id: "stunning_strike", name: "Stunning Strike", icon: "Stunning_strike.webp", level: 5, cost: 1,
          desc: "You interfere with the flow of ki in an opponent's body. When you hit another creature with a melee weapon attack, you can spend 1 ki point to attempt a stunning strike. The target must succeed on a Constitution saving throw or be stunned until the end of your next turn." },
        { id: "focused_aim", name: "Focused Aim", icon: "Focused_aim.webp", level: 5, costOptions: [1,2,3],
          desc: "When you miss with an attack roll, you can spend 1 to 3 ki points to increase your attack roll by 2 for each of these ki points you spend, potentially turning the miss into a hit." },
        { id: "adaptive_physiology", name: "Adaptive Physiology", icon: "Adaptive_physiology.webp", level: 14, cost: 1,
          desc:
`This grants you proficiency in all saving throws.

Additionally, whenever you make a saving throw and fail, you can spend 1 ki point to reroll it and take the second result.` },
        { id: "chromatophore_bloom", name: "Chromatophore Bloom", icon: "Chromatophore_Bloom.webp", level: 18, cost: 4,
          desc: "You can use your action to spend 4 ki points to become invisible for 1 minute. During that time, you also have resistance to all damage but force damage." },
        { id: "separation_body_soul", name: "Separation of Body and Soul", icon: "separation_body_soul.webp", level: 18, cost: 8,
          desc: "You can spend 8 ki points to cast the astral projection spell, without needing material components. When you do so, you can't take any other creatures with you." },
      ];

      const REF_FEATURES = [
        { level: 2, name: "Unarmored Movement (feature reminder)",
          desc:
`Your speed increases by 10 feet while you are not wearing armor or wielding a shield. This bonus increases when you reach certain monk levels, as shown in the Monk table.

At 9th level, you gain the ability to move along vertical surfaces and across liquids on your turn without falling during the move.` },
        { level: 4, name: "Adaptive Landing Reflex",
          desc: "You can use your reaction when you fall to reduce any falling damage you take by an amount equal to five times your monk level." },
        { level: 5, name: "Extra Attack",
          desc: "Beginning at 5th level, you can attack twice, instead of once, whenever you take the Attack action on your turn." },
        { level: 7, name: "Evasion",
          desc: "When you are subjected to an effect that allows you to make a Dexterity saving throw to take only half damage, you instead take no damage if you succeed on the saving throw, and only half damage if you fail." },
        { level: 7, name: "Stillness of Mind",
          desc: "You can use your action to end one effect on yourself that is causing you to be charmed or frightened." },
        { level: 10, name: "Purity of Body",
          desc: "Your mastery of the ki flowing through you makes you immune to disease and poison." },
        { level: 13, name: "Tongue of the Sun and Moon",
          desc: "You understand all spoken languages. Moreover, any creature that can understand a language can understand what you say." },
        { level: 15, name: "Timeless Body",
          desc: "You suffer none of the frailty of old age, and you can't be aged magically. You can still die of old age. In addition, you no longer need food or water." },
        { level: 20, name: "Perfect Self",
          desc: "When you roll for initiative and have no ki points remaining, you regain 4 ki points." },
      ];

      function normalizePath(p) {
        p = (p || "").trim();
        // accept values like "icons", "/icons", "./icons"
        p = p.replace(/^\/+/, "");     // strip leading slashes
        p = p.replace(/^\.\//, "");    // strip leading ./
        if (!p) return "./";
        if (!p.endsWith("/")) p += "/";
        return "./" + p;
      }

      function loadState() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return { level: 2, ki: 2 };
          const parsed = JSON.parse(raw);
          return { level: clamp(Number(parsed.level) || 2, 1, 20), ki: Math.max(0, Number(parsed.ki) || 0) };
        } catch {
          return { level: 2, ki: 2 };
        }
      }
      function saveState(s) { localStorage.setItem(STORAGE_KEY, JSON.stringify(s)); }

      function loadPaths() {
        try {
          const raw = localStorage.getItem(PATHS_KEY);
          if (!raw) return null;
          const p = JSON.parse(raw);
          return {
            iconsBase: normalizePath(p.iconsBase || "icons/"),
            uiBase: normalizePath(p.uiBase || "UI/"),
          };
        } catch {
          return null;
        }
      }
      function savePaths(p) { localStorage.setItem(PATHS_KEY, JSON.stringify(p)); }

      function preload(url) {
        return new Promise((resolve) => {
          const img = new Image();
          img.onload = () => resolve({ ok: true, url });
          img.onerror = () => resolve({ ok: false, url });
          img.src = url;
        });
      }

      async function resolveFirstWorking(base, candidates) {
        for (const name of candidates) {
          const url = base + name;
          const r = await preload(url);
          if (r.ok) return url;
        }
        return null;
      }

      const el = {};
      let state = loadState();

      // Default to your real folders if nothing saved yet
      let paths = loadPaths() || { iconsBase: "./icons/", uiBase: "./UI/" };

      function normalize() {
        state.level = clamp(Number(state.level) || 1, 1, 20);
        const max = getMaxKI(state.level);
        state.ki = clamp(Number(state.ki) || 0, 0, max);
      }

      function setStatus(targetEl, msg, kind = "") {
        targetEl.textContent = msg || "";
        targetEl.classList.remove("ok", "error");
        if (kind) targetEl.classList.add(kind);
      }

      async function setBackground() {
        const bgUrl = await resolveFirstWorking(paths.uiBase, FILES.uiBackgroundCandidates);
        if (bgUrl) {
          document.body.style.backgroundImage = `url("${bgUrl}")`;
          document.body.style.backgroundRepeat = "no-repeat";
          document.body.style.backgroundPosition = "center top";
          document.body.style.backgroundAttachment = "fixed";
          document.body.style.backgroundSize = "cover";
        } else {
          document.body.style.backgroundImage = "none";
        }
        return bgUrl;
      }

      function renderTopStats() {
        const max = getMaxKI(state.level);
        el.kiText.textContent = `${state.ki} / ${max}`;

        const idx = clamp(state.level, 1, 20) - 1;
        el.moveText.textContent = UNARMORED_MOVE[idx] || "-";
        el.madText.textContent = MARTIAL_DIE[idx] || "1d4";
      }

      function attachFallbackImg(imgEl, urlCandidates, altText) {
        let i = 0;
        imgEl.alt = altText || "image";
        imgEl.loading = "lazy";
        imgEl.referrerPolicy = "no-referrer";

        const tryNext = () => {
          if (i >= urlCandidates.length) {
            imgEl.removeAttribute("src");
            imgEl.style.display = "none";
            return;
          }
          imgEl.style.display = "block";
          imgEl.src = urlCandidates[i++];
        };

        imgEl.onerror = () => tryNext();
        tryNext();
      }

      async function renderKIBar() {
        const max = getMaxKI(state.level);
        el.kiBar.innerHTML = "";

        const availUrl = paths.uiBase + FILES.kiAvailable;
        const spentUrl = paths.uiBase + FILES.kiSpent;

        for (let i = 1; i <= max; i++) {
          const orb = document.createElement("div");
          orb.className = "kiOrb";
          const img = document.createElement("img");
          const wantAvail = i <= state.ki;
          attachFallbackImg(img, [wantAvail ? availUrl : spentUrl], wantAvail ? "KI available" : "KI spent");
          orb.appendChild(img);
          el.kiBar.appendChild(orb);
        }

        el.spend1.disabled = state.ki <= 0;
        el.gain1.disabled = state.ki >= max;
      }

      function openDialog(title, desc, meta) {
        el.dlgTitle.textContent = title;
        el.dlgDesc.textContent = desc;
        el.dlgMeta.textContent = meta || "";
        if (typeof el.infoDialog.showModal === "function") el.infoDialog.showModal();
        else alert(`${title}\n\n${desc}\n\n${meta || ""}`);
      }

      function spendKI(amount) {
        normalize();
        amount = Number(amount) || 0;
        if (amount <= 0) return true;
        if (state.ki < amount) return false;
        state.ki -= amount;
        return true;
      }

      function refillKI() {
        const max = getMaxKI(state.level);
        state.ki = max;
        saveState(state);
        render();
        setStatus(el.statusBar, "KI refilled.", "ok");
      }

      function renderAbilities() {
        el.abilityGrid.innerHTML = "";

        const max = getMaxKI(state.level);
        const availableAbilities = KI_ABILITIES.filter(a => state.level >= a.level);

        if (availableAbilities.length === 0) {
          const empty = document.createElement("div");
          empty.className = "sub";
          empty.textContent = "No KI abilities available yet (set level to 2+).";
          el.abilityGrid.appendChild(empty);
          return;
        }

        for (const a of availableAbilities) {
          const card = document.createElement("div");
          card.className = "abilityCard";

          const iconWrap = document.createElement("div");
          iconWrap.className = "abilityIcon";

          const img = document.createElement("img");
          img.alt = `${a.name} icon`;
          img.onload = () => {};
          img.onerror = () => { iconWrap.innerHTML = `<div class="missingIcon">Missing icon<br>${a.icon}</div>`; };
          img.src = paths.iconsBase + a.icon;
          iconWrap.appendChild(img);

          const mid = document.createElement("div");
          const name = document.createElement("div");
          name.className = "abilityName";
          name.textContent = a.name;

          const meta = document.createElement("div");
          meta.className = "abilityMeta";
          const costText =
            a.costOptions ? `Cost: ${a.costOptions[0]} to ${a.costOptions[a.costOptions.length - 1]} KI` : `Cost: ${a.cost} KI`;
          meta.textContent = `Unlocked at level ${a.level}. ${costText}.`;

          mid.appendChild(name);
          mid.appendChild(meta);

          const btns = document.createElement("div");
          btns.className = "abilityBtns";

          let costPicker = null;
          if (a.costOptions && Array.isArray(a.costOptions)) {
            costPicker = document.createElement("select");
            costPicker.setAttribute("aria-label", `Choose KI cost for ${a.name}`);
            for (const c of a.costOptions) {
              const opt = document.createElement("option");
              opt.value = String(c);
              opt.textContent = `${c} KI`;
              costPicker.appendChild(opt);
            }
            btns.appendChild(costPicker);
          }

          const useBtn = document.createElement("button");
          useBtn.className = "btn";
          useBtn.type = "button";
          useBtn.textContent = "Use";
          useBtn.disabled = max === 0;

          useBtn.addEventListener("click", () => {
            const amt = a.costOptions ? Number(costPicker.value) : Number(a.cost);
            const ok = spendKI(amt);

            if (!ok) {
              setStatus(el.statusBar, `Not enough KI to use ${a.name} (need ${amt}).`, "error");
              render();
              return;
            }

            saveState(state);
            render();
            setStatus(el.statusBar, `${a.name} used, spent ${amt} KI.`, "ok");
          });

          const q = document.createElement("button");
          q.className = "qBtn";
          q.type = "button";
          q.textContent = "?";
          q.setAttribute("aria-label", `Show definition for ${a.name}`);
          q.addEventListener("click", () => {
            const metaLine = a.costOptions
              ? `Unlocked: level ${a.level}. Cost: ${a.costOptions[0]} to ${a.costOptions[a.costOptions.length - 1]} KI.`
              : `Unlocked: level ${a.level}. Cost: ${a.cost} KI.`;
            openDialog(a.name, a.desc, metaLine);
          });

          btns.appendChild(useBtn);
          btns.appendChild(q);

          card.appendChild(iconWrap);
          card.appendChild(mid);
          card.appendChild(btns);

          el.abilityGrid.appendChild(card);
        }

        const useButtons = el.abilityGrid.querySelectorAll("button.btn");
        let i = 0;
        for (const a of availableAbilities) {
          const btn = useButtons[i++];
          if (!btn) continue;
          const minCost = a.costOptions ? Math.min(...a.costOptions) : a.cost;
          btn.disabled = state.ki < minCost || max === 0;
        }
      }

      function renderReference() {
        el.refList.innerHTML = "";
        const available = REF_FEATURES.filter(r => state.level >= r.level);

        if (available.length === 0) {
          const empty = document.createElement("div");
          empty.className = "sub";
          empty.textContent = "No reference features shown at this level.";
          el.refList.appendChild(empty);
          return;
        }

        for (const r of available) {
          const box = document.createElement("div");
          box.className = "refItem";

          const head = document.createElement("div");
          head.className = "refHead";

          const name = document.createElement("div");
          name.className = "refName";
          name.textContent = r.name;

          const lvl = document.createElement("div");
          lvl.className = "refLevel";
          lvl.textContent = `Level ${r.level}`;

          head.appendChild(name);
          head.appendChild(lvl);

          const desc = document.createElement("div");
          desc.className = "refDesc";
          desc.textContent = r.desc;

          box.appendChild(head);
          box.appendChild(desc);

          el.refList.appendChild(box);
        }
      }

      async function validateAssetsQuick() {
        const checks = [];
        checks.push(preload(paths.uiBase + FILES.kiAvailable));
        checks.push(preload(paths.uiBase + FILES.kiSpent));

        const bgUrl = await resolveFirstWorking(paths.uiBase, FILES.uiBackgroundCandidates);
        checks.push(Promise.resolve({ ok: Boolean(bgUrl), url: bgUrl || (paths.uiBase + FILES.uiBackgroundCandidates[0]) }));

        checks.push(preload(paths.iconsBase + "Patient_Defense.webp"));

        const results = await Promise.all(checks);

        const lines = [];
        let okCount = 0;
        for (const r of results) {
          const ok = r.ok ? "OK" : "MISSING";
          if (r.ok) okCount++;
          lines.push(`${ok}: ${r.url || "(no url)"}`);
        }

        if (okCount === results.length) {
          setStatus(el.assetStatus, "Assets loaded.\n" + lines.join("\n"), "ok");
        } else {
          setStatus(el.assetStatus, "Some assets did not load.\n" + lines.join("\n"), "error");
        }
      }

      async function render() {
        normalize();
        renderTopStats();
        await setBackground();
        await renderKIBar();
        renderAbilities();
        renderReference();
      }

      async function autoDetectAndSave() {
        setStatus(el.assetStatus, "Auto-detecting folders...", "");

        let foundIcons = null;
        for (const p of FOLDER_CANDIDATES.icons) {
          const r = await preload(p + "Patient_Defense.webp");
          if (r.ok) { foundIcons = p; break; }
        }

        let foundUI = null;
        for (const p of FOLDER_CANDIDATES.ui) {
          const r1 = await preload(p + FILES.kiAvailable);
          const r2 = await preload(p + FILES.kiSpent);
          if (r1.ok && r2.ok) { foundUI = p; break; }
        }

        if (foundIcons) paths.iconsBase = foundIcons;
        if (foundUI) paths.uiBase = foundUI;

        savePaths(paths);

        el.iconsBaseInput.value = paths.iconsBase;
        el.uiBaseInput.value = paths.uiBase;

        await render();
        await validateAssetsQuick();

        if (foundIcons && foundUI) {
          setStatus(el.assetStatus, `Auto-detect successful.\nIcons: ${foundIcons}\nUI: ${foundUI}`, "ok");
        } else {
          setStatus(el.assetStatus, `Auto-detect partial.\nIcons: ${foundIcons || "(not found)"}\nUI: ${foundUI || "(not found)"}`, "error");
        }
      }

      async function applyPathsFromInputs() {
        paths.iconsBase = normalizePath(el.iconsBaseInput.value || "icons/");
        paths.uiBase = normalizePath(el.uiBaseInput.value || "UI/");
        savePaths(paths);
        await render();
        await validateAssetsQuick();
      }

      async function resetPaths() {
        paths = { iconsBase: "./icons/", uiBase: "./UI/" };
        savePaths(paths);
        el.iconsBaseInput.value = paths.iconsBase;
        el.uiBaseInput.value = paths.uiBase;
        await render();
        await validateAssetsQuick();
      }

      function init() {
        el.levelInput = document.getElementById("levelInput");
        el.kiText = document.getElementById("kiText");
        el.moveText = document.getElementById("moveText");
        el.madText = document.getElementById("madText");
        el.kiBar = document.getElementById("kiBar");
        el.spend1 = document.getElementById("spend1");
        el.gain1 = document.getElementById("gain1");
        el.shortRest = document.getElementById("shortRest");
        el.longRest = document.getElementById("longRest");
        el.statusBar = document.getElementById("statusBar");
        el.assetStatus = document.getElementById("assetStatus");
        el.abilityGrid = document.getElementById("abilityGrid");
        el.refList = document.getElementById("refList");

        el.iconsBaseInput = document.getElementById("iconsBaseInput");
        el.uiBaseInput = document.getElementById("uiBaseInput");
        el.applyPathsBtn = document.getElementById("applyPathsBtn");
        el.autoDetectBtn = document.getElementById("autoDetectBtn");
        el.resetPathsBtn = document.getElementById("resetPathsBtn");

        el.infoDialog = document.getElementById("infoDialog");
        el.dlgTitle = document.getElementById("dlgTitle");
        el.dlgDesc = document.getElementById("dlgDesc");
        el.dlgMeta = document.getElementById("dlgMeta");
        el.dlgClose = document.getElementById("dlgClose");
        el.dlgX = document.getElementById("dlgX");

        el.levelInput.value = String(state.level);

        // Set inputs to current paths (defaults: ./icons/ and ./UI/)
        el.iconsBaseInput.value = paths.iconsBase;
        el.uiBaseInput.value = paths.uiBase;

        el.applyPathsBtn.addEventListener("click", applyPathsFromInputs);
        el.autoDetectBtn.addEventListener("click", autoDetectAndSave);
        el.resetPathsBtn.addEventListener("click", resetPaths);

        el.levelInput.addEventListener("input", async () => {
          const lvl = clamp(Number(el.levelInput.value), 1, 20);
          state.level = Number.isFinite(lvl) ? lvl : 1;

          const newMax = getMaxKI(state.level);
          state.ki = clamp(state.ki, 0, newMax);

          saveState(state);
          setStatus(el.statusBar, "", "");
          await render();
        });

        el.spend1.addEventListener("click", async () => {
          if (!spendKI(1)) {
            setStatus(el.statusBar, "Not enough KI to spend 1.", "error");
            await render();
            return;
          }
          saveState(state);
          await render();
          setStatus(el.statusBar, "Spent 1 KI.", "ok");
        });

        el.gain1.addEventListener("click", async () => {
          const max = getMaxKI(state.level);
          state.ki = clamp(state.ki + 1, 0, max);
          saveState(state);
          await render();
          setStatus(el.statusBar, "Gained 1 KI.", "ok");
        });

        el.shortRest.addEventListener("click", refillKI);
        el.longRest.addEventListener("click", refillKI);

        el.dlgClose.addEventListener("click", () => el.infoDialog.close());
        el.dlgX.addEventListener("click", () => el.infoDialog.close());

        el.infoDialog.addEventListener("click", (e) => {
          const rect = el.infoDialog.getBoundingClientRect();
          const inside =
            e.clientX >= rect.left && e.clientX <= rect.right &&
            e.clientY >= rect.top && e.clientY <= rect.bottom;
          if (!inside) el.infoDialog.close();
        });

        // First paint with defaults (icons/UI), then verify.
        // If someone clears localStorage or renames folders, auto-detect runs ONCE on first run.
        (async () => {
          await render();
          await validateAssetsQuick();

          const firstRunDone = localStorage.getItem(FIRST_RUN_KEY) === "1";
          const hasSavedPaths = Boolean(localStorage.getItem(PATHS_KEY));

          if (!firstRunDone && !hasSavedPaths) {
            // Run auto-detect only once on a fresh install so it "just works"
            await autoDetectAndSave();
            localStorage.setItem(FIRST_RUN_KEY, "1");
          }
        })();
      }

      document.addEventListener("DOMContentLoaded", init);
    </script>
  </body>
</html>
